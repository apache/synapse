<!--
~ Licensed to the Apache Software Foundation (ASF) under one
~ or more contributor license agreements. See the NOTICE file
~ distributed with this work for additional information
~ regarding copyright ownership. The ASF licenses this file
~ to you under the Apache License, Version 2.0 (the
~ "License"); you may not use this file except in compliance
~ with the License. You may obtain a copy of the License at
~
~ http://www.apache.org/licenses/LICENSE-2.0
~
~ Unless required by applicable law or agreed to in writing,
~ software distributed under the License is distributed on an
~ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
~ KIND, either express or implied. See the License for the
~ specific language governing permissions and limitations
~ under the License.
-->
<html>
<head>
  <meta http-equiv="content-type" content="">
  <title></title>
  <style type="text/css">
  pre {
    font-family: Georgia, "verdena",verdena, serif;
    font-size:10;
    border-style:solid 1px #333;
    color: #000;
        padding-left:10px;
        padding-right:10px;
        background-color: #cdcdcd;
  }
 </style>
</head>

<body>
<h1>Running the Synapse Samples</h1>

<h2><a name="TOC">Contents</a></h2>

<div class="section-content">
<ul>
  <li><a href="#Overview">Overview</a></li>
  <li><a href="#Axis2Server">Starting the Axis2 Server</a></li>
  <li><a href="#MediationSamples">Message mediation samples</a> 
    <ul>
      <li><a href="#Sample0">Sample 0: Introduction to Synapse - log a
        message</a></li>
      <li><a href="#Sample1">Sample 1: Content based routing</a></li>
      <li><a href="#Sample2">Sample 2: Switch-case mediator and writing and
        reading of message properties</a></li>
      <li><a href="#Sample3">Sample 3: Simple properties, and reusable
        endpoints and sequences</a></li>
      <li><a href="#Sample4">Sample 4: Error handling with the try and
        makefault mediators</a></li>
      <li><a href="#Sample5">Sample 5: Error handling within a sequence using
        the 'onError' sequence</a></li>
      <li><a href="#Sample6">Sample 6: Header, in and out mediators</a></li>
      <li><a href="#Sample7">Sample 7: Extension mediators, static XML
        properties and the validate mediator</a></li>
      <li><a href="#Sample8">Sample 8: URL source properties, registry based
        properties and the XSLT mediator</a></li>
      <li><a href="#Sample9">Sample 9: Dynamic sequences with a
      Registry</a></li>
      <li><a href="#Sample10">Sample 10: Dynamic endpoints with a
      Registry</a></li>
      <li><a href="#Sample11">Sample 11: A full registry based
        configuration</a></li>
    </ul>
  </li>
  <li><a href="#WSSecurity">WS-Security</a> 
    <ul>
      <li><a href="#Sample50">Sample 50: Connecting to endpoints with
        WS-Security</a></li>
    </ul>
  </li>
  <li><a href="#ProxyServices">Synapse Proxy service samples</a> 
    <ul>
      <li><a href="#Sample100">Sample 100: Introduction to Synapse proxy
        services</a></li>
      <li><a href="#Sample101">Sample 101: Custom sequences and endpoints for
        message mediation with proxy services</a></li>
      <li><a href="#Sample102">Sample 102: Attaching service level
        WS-Security policies to proxy services</a></li>
      <li><a href="#Sample103">Sample 103: Using WS-Security signing and
        encryption with proxy services through WS-Policy</a></li>
      <li><a href="#Sample104">Sample 104: Explicit out sequence in proxy
        service level to mediate proxy response</a></li>
      <li><a href="#Sample105">Sample 105: Pure POX/Text and Binary JMS Proxy
        services - including MTOM</a></li>
    </ul>
  </li>
  <li><a href="#ProxyServices">Transport samples</a> 
    <ul>
      <li><a href="#Sample110">Sample 110: Introduction to switching
        transports with proxy services</a></li>
      <li><a href="#Sample111">Sample 111: Demonstrate switching from HTTP to
        JMS</a></li>
      <li><a href="#Sample112">Sample 112: Demonstrate one way messaging /
        fireAndForget</a></li>
    </ul>
  </li>
  <li><a href="#ScriptMediators">Script Mediators</a> 
    <ul>
      <li><a href="#ScriptSetup">Setting up Script Mediator support in
        Synapse</a> 
        <ul>
          <li><a href="#ScriptSetupJavaScript">JavaScript</a></li>
          <li><a href="#ScriptSetupRuby">Ruby</a></li>
        </ul>
      </li>
    </ul>
    <ul>
      <li><a href="#Sample500">Sample 500: Introduction to script
        mediators</a></li>
      <li><a href="#Sample501">Sample 501: In-line script mediators</a></li>
      <li><a href="#Sample503">Sample 503: Ruby script mediators</a></li>
    </ul>
  </li>
</ul>
</div>

<h1><a name="MediationSamples">Message Mediation Samples</a></h1>

<h2><a name="Sample0">Sample 0:</a></h2>
<pre>&lt;definitions xmlns="http://ws.apache.org/ns/synapse"&gt;
    &lt;!-- log all attributes of messages passing through --&gt;
    &lt;log level="full"/&gt;

    &lt;!-- Send the messageto implicit destination --&gt;
    &lt;send/&gt;
&lt;/definitions&gt;
 </pre>

<p><strong>Objective: Introduction to Synapse. Shows how a message could be
made to pass through Synapse </strong><strong>and logged before it is
delivered to its ultimate receiver.</strong></p>

<p>The Stock quote client can operate in the following modes for this
example.</p>
<ol>
  <li>Smart Client mode</li>
  <pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/
 </pre>
  <li>Using Synapse as a HTTP Proxy</li>
  <pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dprxurl=http://localhost:8080/</pre>
  <pre></pre>
  <li>Dumb Client</li>

  <p>See sample # 1</p>
</ol>

<p><strong>Pre-Requisites:<br>
</strong>Start the Synapse configuration numbered 0: e.g. synapse -sample
0<br>
Start the Axis2 server and deploy the SimpleStockQuoteService if not already
deployed</p>

<p><strong>Execute the Smart Client </strong></p>

<p>By following through the execution of Synapse through the DEBUG level log
output to the system output stream (i.e. console), you will notice that the
client request arrived at Synapse with a WS-Addressing 'To' EPR of
http://localhost:9000/soap/SimpleStockQuoteService</p>

<p>The Synapse engine now logs the message at the "full" log level (i.e. all
message headers and the body) and sends the message to its implicit 'To'
address - which is http://localhost:9000/soap/SimpleStockQuoteService</p>

<p>Then you will see on the Axis2 server console, a message confirming that
the message got routed to the sample server and the sample service that was
invoked generated a stock quote for the requested symbol.</p>
<pre>Sat Nov 18 21:01:23 IST 2006 SimpleStockQuoteService :: Generating quote for : IBM</pre>

<p>The response message generated by the service is again received by
Synapse, and flows through the same mediation rules, which logs the response
message and then sends it back - this time to the client.</p>

<p>On the client console you should see an output similar to the following
based on the message received by the client.</p>
<pre>Standard :: Stock price = $95.26454380258552</pre>

<p><strong>Execute the Proxy client as 'ant proxystockquote'</strong><br>
Client Code: samples.userguide.ProxyStockQuoteClient</p>

<p>You will see the exact same behaviour as per the previous example when you
run this scenario. However this time the difference is at the client, as it
sends the message to the WS-Addressing 'To' address
http://localhost:9000/soap/SimpleStockQuoteService, but the transport
specifies Synapse as the http proxy. </p>

<h2><a name="Sample1" id="Sample1">Sample 1:</a></h2>
<pre>&lt;!-- simple content based routing of messages --&gt;
&lt;definitions xmlns="http://ws.apache.org/ns/synapse"&gt;
    &lt;!-- filtering of messages with XPath and regex matches --&gt;
    &lt;filter source="get-property('To')" regex=".*/StockQuote.*"&gt;
        &lt;send&gt;
            &lt;endpoint&gt;
                &lt;address uri="http://localhost:9000/soap/SimpleStockQuoteService"/&gt;
            &lt;/endpoint&gt;
        &lt;/send&gt;
    &lt;/filter&gt;
    &lt;send/&gt;
&lt;/definitions&gt; </pre>

<p><strong>Objective: Introduction to simple content based routing. Shows how
a message could be made to pass through Synapse using the Dumb Client mode,
where Synapse acts as a gateway to accept all messages and then perform
mediation and routing based on message properties or content.</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Start the Synapse configuration numbered 1: i.e. synapse -sample 1<br>
Start the Axis2 server and deploy the SimpleStockQuoteService if not already
deployed<br>
</p>

<p>Execute the Dumb Client as: </p>
<pre>ant stockquote -Dtrpurl=http://localhost:8080/soap/StockQuote<br></pre>

<p>This time you will notice that Synapse received a message for which
Synapse was set as the ultimate receiver of the message. Based on the 'To'
EPR of http://localhost:8080/soap/StockQuote, Synapse performes a match to
the path '/StockQuote' and as the request matched the XPath expression of the
filter mediator, the filter mediators' child mediators executes, and thereby
sending the message to a different endpoint as specified by the endpoint
definition. The 'drop' mediator terminates further processing of the current
message in a configuration. During response processing, the filter condition
fails, and thus the implicit 'send' mediator forwards the reply back to the
client.</p>

<h2><a name="Sample2">Sample 2:</a></h2>
<pre>&lt;!-- switch-case mediator and setting and reading of local properties on a message --&gt;
&lt;definitions xmlns="http://ws.apache.org/ns/synapse"&gt;

    &lt;!-- introduction to switch-case-default mediator --&gt;
    &lt;switch source="//m0:getQuote/m0:request/m0:symbol" xmlns:m0="http://services.samples/xsd"&gt;
        &lt;case regex="IBM"&gt;
            &lt;!-- the property mediator sets a local property on the *current* message --&gt;
            &lt;property name="symbol" value="Great stock - IBM"/&gt;
        &lt;/case&gt;
        &lt;case regex="MSFT"&gt;
            &lt;property name="symbol" value="Are you sure? - MSFT"/&gt;
        &lt;/case&gt;
        &lt;default&gt;
            &lt;!-- it is possible to assign the result of an XPath expression as well --&gt;
            &lt;set-property name="symbol"
                  expression="fn:concat('Normal Stock - ', //m0:getQuote/m0:request/m0:symbol)"
                  xmlns:m0="http://services.samples/xsd"/&gt;
        &lt;/default&gt;
    &lt;/switch&gt;

    &lt;log level="custom"&gt;
        &lt;!-- the get-property() XPath extension function allows the lookup of local message properties
            as well as properties from the Axis2 or Transport contexts (i.e. transport headers) --&gt;
        &lt;property name="symbol" expression="get-property('symbol')"/&gt;
        &lt;!-- the get-property() function supports the implicit message headers To/From/Action/FaultTo/ReplyTo --&gt;
        &lt;property name="epr" expression="get-property('To')"/&gt;
    &lt;/log&gt;

    &lt;!-- Send the messages where they are destined to (i.e. the 'To' EPR of the message) --&gt;
    &lt;send/&gt;

&lt;/definitions&gt;</pre>

<p><strong>Objective: Introduce switch-case mediator and writing and reading
of local properties set on a message instance</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Start the Synapse configuration numbered 2: i.e. synapse -sample 2<br>
Start the Axis2 server and deploy the SimpleStockQuoteService if not already
done.</p>

<p>Execute the 'ant stockquote ..' request again in the smart client mode,
specifying 'IBM', 'MSFT' and 'SUN' as the stock symbols. When the symbol IBM
is request, following through the mediation logs you will see that the case
statements' first case for 'IBM' executed and a local property named 'symbol'
was set to 'Great stock - IBM'. Subsequently this local property value is
looked up by the log mediator and logged using the 'get-property()' XPath
extension function.</p>

<p>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService
-Dtrpurl=http://localhost:8080/ -Dsymbol=IBM</p>
<pre>INFO LogMediator - symbol = Great stock - IBM, epr = http://localhost:9000/axis2/services/SimpleStockQuoteService </pre>

<p>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService
-Dtrpurl=http://localhost:8080/ -Dsymbol=MSFT</p>
<pre>INFO LogMediator - symbol = Are you sure? - MSFT, epr = http://localhost:9000/axis2/services/SimpleStockQuoteService</pre>

<h2><a name="Sample3" id="Sample3">Sample 3:</a></h2>
<pre>&lt;!-- illustration of local registry entry definitions, and reusable endpoints and sequences --&gt;
&lt;definitions xmlns="http://ws.apache.org/ns/synapse"&gt;
    &lt;!-- define a string resource entry to the local registry --&gt;
    &lt;localEntry key="version"&gt;0.1&lt;/localEntry&gt;
    &lt;!-- define a reuseable endpoint definition --&gt;
    &lt;endpoint name="simple"&gt;
        &lt;address uri="http://localhost:9000/soap/SimpleStockQuoteService"/&gt;
    &lt;/endpoint&gt;

    &lt;!-- define a reusable sequence --&gt;
    &lt;sequence name="stockquote"&gt;
        &lt;!-- log the message using the custom log level. illustrates custom properties for log --&gt;
        &lt;log level="custom"&gt;
            &lt;property name="Text" value="Sending quote request"/&gt;
            &lt;property name="version" expression="get-property('version')"/&gt;
            &lt;property name="direction" expression="get-property('direction')"/&gt;
        &lt;/log&gt;
        &lt;!-- send message to real endpoint referenced by key "simple" endpoint definition --&gt;
        &lt;send&gt;
            &lt;endpoint key="simple"/&gt;
        &lt;/send&gt;
    &lt;/sequence&gt;

    &lt;sequence name="main"&gt;
        &lt;in&gt;
            &lt;property name="direction" value="incoming"/&gt;
            &lt;sequence key="stockquote"/&gt;
        &lt;/in&gt;
        &lt;out&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/sequence&gt;
&lt;/definitions&gt;</pre>

<p><strong>Objective: Illustrates local registry entry definitions, reusable
endpoints and sequences</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Start the Synapse configuration numbered 3: i.e. synapse -sample 3<br>
Start the Axis2 server and deploy the SimpleStockQuoteService if not already
done</p>

<p>This example uses a sequence named as "main" that specifies the main
mediation rules to be executed. This is equivalent to specifying the
mediators of the main sequence within the &lt;definitions&gt; tags directly -
but is the reccomended and neater approach for non trivial configurations.</p>

<p>Execute the 'ant stockquote ..' request again, and following through the
mediation logs you will now notice that the sequence named "main" executed.
Then for the incoming message flow the &lt;in&gt; mediator executes, and it
calls into the sequence named "stockquote"</p>
<pre>DEBUG SequenceMediator - Sequence mediator &lt;main&gt; :: mediate()<br>DEBUG InMediator - In mediator mediate()<br>DEBUG SequenceMediator - Sequence mediator &lt;stockquote&gt; :: mediate()</pre>

<p>As the "stockquote" sequence executes, the log mediator dumps a simple
text/string property, an XPath evaluation result - that picks up the key
named "version", and a second XPath evaluation result that picks up a local
message property set previously by the &lt;property&gt; mediator. The
get-property() XPath extension function is able to read message properties
local to the current message, local or remote registry entries, Axis2 message
context properties as well as transport headers. The local entry definition
for "version" defines a simple text/string registry entry for that is visible
to all messages that passes through Synapse.</p>
<pre>[HttpServerWorker-1] INFO  LogMediator - Text = Sending quote request, version = 0.1, direction = incoming 
[HttpServerWorker-1] DEBUG SendMediator - Send mediator :: mediate() 
[HttpServerWorker-1] DEBUG AddressEndpoint - Sending To: http://localhost:9000/soap/SimpleStockQuoteService </pre>

<h2><a name="Sample41" id="Sample41">Sample 4:</a></h2>
<pre>&lt;!-- introduction to error handling --&gt;
&lt;definitions xmlns="http://ws.apache.org/ns/synapse"&gt;

    &lt;!-- the default fault handling sequence used by Synapse - named 'fault' --&gt;
    &lt;sequence name="fault"&gt;
        &lt;log level="custom"&gt;
            &lt;property name="text" value="An unexpected error occured"/&gt;
            &lt;property name="message" expression="get-property('ERROR_MESSAGE')"/&gt;
        &lt;/log&gt;
&lt;drop/&gt;
    &lt;/sequence&gt;

&lt;sequence name="sunErrorHandler"&gt;
        &lt;log level="custom"&gt;
            &lt;property name="text" value="An unexpected error occured for stock SUN"/&gt;
            &lt;property name="message" expression="get-property('ERROR_MESSAGE')"/&gt;
        &lt;/log&gt;
&lt;drop/&gt;
    &lt;/sequence&gt;

    &lt;!-- default message handling sequence used by Synapse - named 'main' --&gt;
    &lt;sequence name="main"&gt;
        &lt;in&gt;
            &lt;switch source="//m0:getQuote/m0:request/m0:symbol" xmlns:m0="http://services.samples/xsd"&gt;
                &lt;case regex="IBM"&gt;
                    &lt;send&gt;
                        &lt;endpoint&gt;&lt;address uri="http://localhost:9000/soap/SimpleStockQuoteService"/&gt;&lt;/endpoint&gt;
                    &lt;/send&gt;
                &lt;/case&gt;
                &lt;case regex="MSFT"&gt;
                    &lt;send&gt;
                        &lt;endpoint key="bogus"/&gt;
                    &lt;/send&gt;
                &lt;/case&gt;
                &lt;case regex="SUN"&gt;
                    &lt;sequence key="sunSequence"/&gt;
                &lt;/case&gt;
            &lt;/switch&gt;
            &lt;drop/&gt;
        &lt;/in&gt;

        &lt;out&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/sequence&gt;

&lt;sequence name="sunSequence" onError="sunErrorHandler"&gt;
        &lt;send&gt;
            &lt;endpoint key="sunPort"/&gt;
        &lt;/send&gt;
&lt;/sequence&gt;

&lt;/definitions&gt; </pre>

<p><strong>Objective: Introduction to error handling with the 'fault'
sequence</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Start the Synapse configuration numbered 4: i.e. synapse -sample 4<br>
Start the Axis2 server and deploy the SimpleStockQuoteService if not already
done</p>

<p>When the IBM stock quote is requested, the configuration routes it to the
endpoint defined as the 'simple' endpoint, which routes the message to the
SimpleStockQuoteService on the local Axis2 instance. Hence a valid response
message is shown at the client.</p>

<p>If you lookup a stock quote for 'MSFT', Synapse is instructed to route the
message to the endpoint defined as the 'bogus' endpoint, which does not
exist. Synapse executes the specified error handler sequence closest to the
point where the error was encountered. In this case, the currently executing
sequence is 'main' and it does not specify an 'onError' attribute. Whenever
Synapse cannot find an error handler, it looks up for a sequence named
'fault'. Thus the 'fault' sequence can be seen executing, and writing the
generic error message into the logs. </p>
<pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/ -Dsymbol=MSFT</pre>
<pre>[HttpServerWorker-1] DEBUG SendMediator - Send mediator :: mediate() 
[HttpServerWorker-1] ERROR IndirectEndpoint - Reference to non-existent endpoint for key : bogus 
[HttpServerWorker-1] DEBUG MediatorFaultHandler - MediatorFaultHandler :: handleFault 
[HttpServerWorker-1] DEBUG SequenceMediator - Sequence mediator &lt;fault&gt; :: mediate() 
[HttpServerWorker-1] DEBUG LogMediator - Log mediator :: mediate() 
[HttpServerWorker-1] INFO  LogMediator - text = An unexpected error occured, message = Reference to non-existent endpoint for key : bogus</pre>

<p>When the 'SUN' quote is requested, a custom sequence 'sunSequence' is
invoked, and it specifies 'sunErrorHandler' as its error handler. Hence when
the send fails, now you could see the proper error handler invocation and the
custom error message as follows:</p>
<pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/ -Dsymbol=SUN

[HttpServerWorker-1] DEBUG SequenceMediator - Sequence mediator &lt;sunSequence&gt; :: mediate() 
[HttpServerWorker-1] DEBUG SequenceMediator - Setting the onError handler for the sequence 
[HttpServerWorker-1] DEBUG AbstractListMediator - Implicit Sequence &lt;SequenceMediator&gt; :: mediate() 
[HttpServerWorker-1] DEBUG SendMediator - Send mediator :: mediate() 
[HttpServerWorker-1] ERROR IndirectEndpoint - Reference to non-existent endpoint for key : sunPort 
[HttpServerWorker-1] DEBUG MediatorFaultHandler - MediatorFaultHandler :: handleFault 
[HttpServerWorker-1] DEBUG SequenceMediator - Sequence mediator &lt;sunErrorHandler&gt; :: mediate() 
[HttpServerWorker-1] DEBUG AbstractListMediator - Implicit Sequence &lt;SequenceMediator&gt; :: mediate() 
[HttpServerWorker-1] DEBUG LogMediator - Log mediator :: mediate() 
[HttpServerWorker-1] INFO  LogMediator - text = An unexpected error occured for stock SUN, message = Reference to non-existent endpoint for key : sunPort</pre>

<h2>Sample 5:</h2>
<pre>&lt;definitions xmlns="http://ws.apache.org/ns/synapse"&gt;

    &lt;sequence name="myFaultHandler"&gt;
        &lt;makefault&gt;
            &lt;code value="tns:Receiver" xmlns:tns="http://www.w3.org/2003/05/soap-envelope"/&gt;
            &lt;reason expression="get-property('ERROR_MESSAGE')"/&gt;
        &lt;/makefault&gt;

        &lt;property name="RESPONSE" value="true"/&gt;
        &lt;header name="To" expression="get-property('ReplyTo')"/&gt;
        &lt;send/&gt;
    &lt;/sequence&gt;

    &lt;sequence name="main" onError="myFaultHandler"&gt;
        &lt;in&gt;
            &lt;switch source="//m0:getQuote/m0:request/m0:symbol"
                    xmlns:m0="http://services.samples/xsd"&gt;
                &lt;case regex="MSFT"&gt;
                    &lt;send&gt;&lt;endpoint name="bogusHost"&gt;
                            &lt;address uri="http://bogus:9000/soap/NonExistentStockQuoteService"/&gt;
                    &lt;/endpoint&gt;&lt;/send&gt;
                &lt;/case&gt;
                &lt;case regex="SUN"&gt;
                    &lt;send&gt;&lt;endpoint name="bogusPort"&gt;
                            &lt;address uri="http://localhost:9009/soap/NonExistentStockQuoteService"/&gt;
                    &lt;/endpoint&gt;&lt;/send&gt;
                &lt;/case&gt;
            &lt;/switch&gt;
            &lt;drop/&gt;
        &lt;/in&gt;

        &lt;out&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/sequence&gt;

&lt;/definitions&gt;</pre>

<p><strong>Objective: Makefault mediator and sending back error responses
</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Start the Synapse configuration numbered 4: i.e. synapse -sample 5<br>
Start the Axis2 server and deploy the SimpleStockQuoteService if not already
done</p>

<p>When the MSFT stock quote is requested, an unknown host exception would be
caused, and a connection refuxed exception would be caused for the SUN stock.
This information is captured and returned back to the original client as a
SOAP fault in this example.</p>
<pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/ -Dsymbol=MSFT</pre>

<p>Returns:</p>
<pre>&lt;soapenv:Fault xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"&gt;&lt;faultcode&gt;soapenv:Client&lt;/faultcode&gt;
&lt;faultstring&gt;java.net.UnknownHostException: bogus&lt;/faultstring&gt;&lt;detail /&gt;&lt;/soapenv:Fault&gt;</pre>

<p>And</p>
<pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/ -Dsymbol=SUN</pre>

<p>Returns:</p>
<pre>&lt;soapenv:Fault xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"&gt;&lt;faultcode&gt;soapenv:Client&lt;/faultcode&gt;
&lt;faultstring&gt;java.net.ConnectException: Connection refused&lt;/faultstring&gt;&lt;detail /&gt;&lt;/soapenv:Fault&gt;</pre>

<h2><a name="Sample6">Sample 6:</a></h2>
<pre>&lt;definitions xmlns="http://ws.apache.org/ns/synapse"&gt;
    &lt;in&gt;
        &lt;header name="To" value="http://localhost:9000/soap/SimpleStockQuoteService"/&gt;
    &lt;/in&gt;
    &lt;send/&gt;
&lt;/definitions&gt;</pre>

<p><strong>Objective: Introduction to header, in (out) mediators</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Start the Synapse configuration numbered 6: i.e. synapse -sample 6<br>
Start the Axis2 server and deploy the SimpleStockQuoteService if not already
done</p>

<p>In this example we use the stockquote client in the dumb client mode,
setting the 'To' EPR of the message to Synapse. Then the 'in' mediator
processes the incoming messages, and manipulates the 'To' header to refer to
the stock quote service on the sample Axis2 server. Thus it is now possible
to request for a stock quote as follows:</p>
<pre>ant stockquote -Dtrpurl=http://localhost:8080/soap/SimpleStockQuoteService</pre>

<h2><a name="Sample7">Sample 7:</a></h2>
<pre>&lt;!-- introduction of static inline XML properties and the validation mediator --&gt;
&lt;definitions xmlns="http://ws.apache.org/ns/synapse"&gt;

    &lt;localEntry key="validate_schema"&gt;
        &lt;xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"
                    xmlns="http://www.apache-synapse.org/test" elementFormDefault="qualified"
                    attributeFormDefault="unqualified"
                    targetNamespace="http://services.samples/xsd"&gt;
            &lt;xs:element name="getQuote"&gt;
                &lt;xs:complexType&gt;
                    &lt;xs:sequence&gt;
                        &lt;xs:element name="request"&gt;
                            &lt;xs:complexType&gt;
                                &lt;xs:sequence&gt;
                                    &lt;xs:element name="stocksymbol" type="xs:string"/&gt;
                                &lt;/xs:sequence&gt;
                            &lt;/xs:complexType&gt;
                        &lt;/xs:element&gt;
                    &lt;/xs:sequence&gt;
                &lt;/xs:complexType&gt;
            &lt;/xs:element&gt;
        &lt;/xs:schema&gt;
    &lt;/localEntry&gt;

    &lt;in&gt;
        &lt;validate&gt;
            &lt;schema key="validate_schema"/&gt;
            &lt;on-fail&gt;
                &lt;!-- if the request does not validate againt schema throw a fault --&gt;
                &lt;makefault&gt;
                    &lt;code value="tns:Receiver"
                            xmlns:tns="http://www.w3.org/2003/05/soap-envelope"/&gt;
                    &lt;reason value="Invalid custom quote request"/&gt;
                &lt;/makefault&gt;
                &lt;property name="RESPONSE" value="true"/&gt;
                &lt;header name="To" expression="get-property('ReplyTo')"/&gt;
            &lt;/on-fail&gt;
        &lt;/validate&gt;
    &lt;/in&gt;
    &lt;send/&gt;
&lt;/definitions&gt; </pre>

<p><strong>Objective: Introduction to local (static) registry entries and the
validate mediator</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Start the Synapse configuration numbered 7: i.e. synapse -sample 7<br>
Start the Axis2 server and deploy the SimpleStockQuoteService if not already
done</p>

<p>This example shows how a static XML fragment could be made available to
the Synapse local registry. Resources defined to the local registry are
static (i.e. never changes over the lifetime of the configuration) and may be
specified as a source URL, inline-text or inline-xml. In this example the
schema is made available under the key 'validate_schema'.</p>

<p>The validate mediator by default operates on the first child element of
the SOAP body. You may specify an XPath expression using the 'source'
attribute to override this behaviour. The validate mediator now uses the
'validate_schema' resource to validate the incoming message, and if the
message is in error invokes on the 'on-fail' sequence of mediators.</p>

<p>If you send a stockquote request using 'ant stockquote ..' you will now
get a fault back with a message 'Invalid custom quote request' as the schema
validation failed. This is because the schema used in the example expects a
slightly different message than what is created by the stock quote client.
(i.e. expects a 'stocksymbol' element instead of 'symbol' to specify thestock
symbol)</p>

<h2><a name="Sample8">Sample 8:</a></h2>
<pre>&lt;!-- introduction to static and dynamic registry resources and the XSLT mediator --&gt;
&lt;definitions xmlns="http://ws.apache.org/ns/synapse"&gt;

    &lt;!-- the SimpleURLRegistry allows access to a URL based registry (e.g. file:/// or http://) --&gt;
    &lt;registry provider="org.apache.synapse.registry.url.SimpleURLRegistry"&gt;
        &lt;!-- the root property of the simple URL registry helps resolve a resource URL as root + key --&gt;
        &lt;parameter name="root"&gt;file:./repository/conf/sample/resources/&lt;/parameter&gt;
        &lt;!-- all resources loaded from the URL registry would be cached for this number of milli seconds --&gt;
        &lt;parameter name="cachableDuration"&gt;15000&lt;/parameter&gt;
    &lt;/registry&gt;

    &lt;!-- define the request processing XSLT resource as a static URL source --&gt;
    &lt;localEntry key="xslt-key-req" src="file:repository/conf/sample/resources/transform/transform.xslt"/&gt;

    &lt;in&gt;
        &lt;!-- transform the custom quote request into a standard quote requst expected by the service --&gt;
        &lt;xslt key="xslt-key-req"/&gt;
    &lt;/in&gt;
    &lt;out&gt;
        &lt;!-- transform the standard response back into the custom format the client expects --&gt;
    &lt;!-- the key is looked up in the remote registry and loaded as a 'dynamic' registry resource --&gt;
        &lt;xslt key="transform/transform_back.xslt"/&gt;
    &lt;/out&gt;
&lt;send/&gt;
&lt;/definitions&gt;</pre>

<p><strong>Objective: Introduction to static and dynamic registry resources
and the XSLT mediator</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Start the Synapse configuration numbered 8: i.e. synapse -sample 8<br>
Start the Axis2 server and deploy the SimpleStockQuoteService if not already
done</p>

<p>This example uses the XSLT mediator to perform transformations, and the
xslt tranformations are specified as registry resources. The first resource
'xslt-key-req' is specified as a 'local' registry entry. Local entries do not
place the resource on the registry, but simply makes it available to the
local configuration. If a local entry is defined with a key that already
exists in the remote registry, the local entry will have preference and hide
the existence of the remote resource.</p>

<p>In this example you will notice the new 'registry' definition. Synapse
comes with a simple URL based registry implementation SimpleURLRegistry.
During initialization of the registry, the SimpleURLRegistry expects to find
a property named 'root', which specifies a prefix for the registry keys used
later. When the SimpleURLRegistry is used, this root is prefixed to the entry
keys to form the complete URL for the resource being looked up. The registry
caches a resource once requested, and caches it internally for a specified
duration. Once this period expires, it will reload the meta information about
the resource and reload its cached copy if necessary, the next time the
resource is requested.</p>

<p>Hence the second XSLT resource key 'transform/transform_back.xslt'
concatenated with the 'root' of the SimpleURLRegistry
'file:repository/conf/sample/resources/' forms the complete URL of the
resource as
'file:repository/conf/sample/resources/transform/transform_back.xslt' and
caches its value for a period of 15000 ms.</p>

<p>Execute the custom quote client as 'ant stockquote -Dmode=customquote ..'
and analyze the the Synapse debug log output as shown below</p>
<pre>ant stockquote -Daddurl=http://localhost:9000/soap/SimpleStockQuoteService -Dtrpurl=http://localhost:8080/ -Dmode=customquote
</pre>
<pre>[HttpServerWorker-1] DEBUG XSLTMediator - Performing XSLT transformation against property with key : xslt-key-req 
[HttpServerWorker-1] DEBUG XSLTMediator - Transformation source : 
    &lt;m0:CheckPriceRequest xmlns:m0="http://www.apache-synapse.org/test"&gt;&lt;m0:Code&gt;IBM&lt;/m0:Code&gt;&lt;/m0:CheckPriceRequest&gt; 
[HttpServerWorker-1] DEBUG XSLTMediator - Transformation result : &lt;m:getQuote xmlns:m="http://services.samples/xsd"&gt;</pre>

<p>The incoming message is now transformed into a standard stock quote
request as expected by the SimpleStockQuoteService deployed on the local
Axis2 instance, by the XSLT mediator. The XSLT mediator uses Xalan-J to
perform the transformations. It is possible to configure the underlying
transformation engine using properties where necessary. The response from the
SimpleStockQuoteService is converted back into the custom format as expected
by the client during the out message processing.</p>

<p>During the response processing you could notice the SimpleURLRegistry
fetching the resource as shown by the log message below</p>
<pre>[HttpClientWorker-1] INFO  SimpleURLRegistry - ==&gt; Repository fetch of resource with key : transform/transform_back.xslt</pre>

<p>If you re-run the client again immidiately (i.e within 15 seconds of the
first request) you will not see the resource being re-loaded by the registry
as the cached value would be still valid.</p>

<p>However if you leave the system idle for 15 seconds or more and then retry
the same request, you will now notice that the registry noticed the cache
expiry and checked the meta information about the resource to check if the
resource itself has changes and requires a fresh fetch from the source URL.
If the meta data / version number indicates that a reload of the cached
resource is not necessary (i.e. unless the resource itself actually changed)
the updated meta information is used and the cache lease extended as
appropriate.</p>
<pre>[HttpClientWorker-1] DEBUG AbstractRegistry - Cached object has expired for key : transform/transform_back.xslt 
[HttpClientWorker-1] DEBUG SimpleURLRegistry - Perform RegistryEntry lookup for key : transform/transform_back.xslt 
[HttpClientWorker-1] DEBUG AbstractRegistry - Expired version number is same as current version in registry 
[HttpClientWorker-1] DEBUG AbstractRegistry - Renew cache lease for another 15s </pre>

<p>Now edit the
repository/conf/sample/resources/transform/transform_back.xslt file and add a
blank line at the end. Now when you run the client again, and if the cache is
expired, the resource would be re-fetched from its URL by the registry and
this can be seen by the following debug log messages</p>
<pre>[HttpClientWorker-1] DEBUG AbstractRegistry - Cached object has expired for key : transform/transform_back.xslt 
[HttpClientWorker-1] DEBUG SimpleURLRegistry - Perform RegistryEntry lookup for key : transform/transform_back.xslt 
[HttpClientWorker-1] INFO  SimpleURLRegistry - ==&gt; Repository fetch of resource with key : transform/transform_back.xslt </pre>

<p>Thus the SimpleURLRegistry allows resource to be cached, and updates
detected so that changes could be reloaded without restarting the Synapse
instance.</p>

<p></p>

<h2><a name="Sample9">Sample 9:</a></h2>
<pre>&lt;synapse xmlns="http://ws.apache.org/ns/synapse"&gt;
    &lt;!-- introduction dynamic sequences --&gt;

    &lt;registry provider="org.apache.synapse.registry.url.SimpleURLRegistry"&gt;
        &lt;!-- the root property of the simple URL registry helps resolve a resource URL as root + key --&gt;
        &lt;property name="root" value="file:repository/conf/sample/resources/"/&gt;
        &lt;!-- all resources loaded from the URL registry would be cached for this number of milli seconds --&gt;
        &lt;property name="cachableDuration" value="15000"/&gt;
    &lt;/registry&gt;

    &lt;definitions&gt;
        &lt;sequence name="dynamic_sequence" key="sequence/dynamic_seq_1.xml"/&gt;
    &lt;/definitions&gt;

    &lt;rules&gt;
        &lt;sequence ref="dynamic_sequence"/&gt;
    &lt;/rules&gt;
&lt;/synapse&gt; </pre>

<p><strong>Objective: Introduction to dynamic sequences with a
Registry</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Start the Synapse configuration numbered 9: i.e. synapse -sample 9<br>
Start the Axis2 server and deploy the SimpleStockQuoteService (Refer steps
above)</p>

<p>This example introduces the dynamic behaviour of Synapse through the use
of a Registry. Synapse supports dynamic definitions for sequences, the main
rules, endpoints and as seen before resources and properties. In this example
we define a Synapse configuration which references a sequence definition
specified as a registry key. The registry key resolves to the actual content
of the sequence which would be loaded dynamically by Synapse at runtime, and
cached accordingly as per its registry definition. Once the cache expires,
Synapse would recheck the meta information for the definition and re-load the
sequence definition if necessary and re-cache it again.</p>

<p>Once Synapse is started, execute the stock quote client as 'ant
stockquote'. You will notice that that Synapse fetches the definition of the
sequence from the registry and executes its rules as follows:</p>
<pre>DEBUG SequenceMediator - Sequence mediator &lt;anonymous&gt; :: mediate()<br>INFO SimpleURLRegistry - ==&gt; Repository fetch of resource with key : sequence/dynamic_seq_1.xml<br>.....<br>INFO LogMediator - message = *** Test Message 1 ***<br>...</pre>

<p>Now if you execute the client immidiately (i.e. within 15 seconds of the
last execution) you will notice that the sequence was not reloaded. If you
now edit the repository/conf/sample/resources/sequence/dynamic_seq_1.xml and
edit the log message to read as "*** Test Message 2 ***" and execute the
client again, you will notice that the new message is not yet visible (i.e.
if you execute this within 15 seconds of loading the resource for the first
time) However, after 15 seconds have elapsed since the original caching of
the sequence, you will notice that the new sequence is loaded and executed by
Synapse from the following log messages:</p>
<pre>DEBUG SequenceMediator - Sequence mediator &lt;anonymous&gt; :: mediate()<br>DEBUG AbstractRegistry - Cached object has expired for key : sequence/dynamic_seq_1.xml<br>DEBUG SimpleURLRegistry - Perform RegistryEntry lookup for key : sequence/dynamic_seq_1.xml<br>INFO SimpleURLRegistry - ==&gt; Repository fetch of resource with key : sequence/dynamic_seq_1.xml<br>...<br>INFO LogMediator - message = *** Test Message 2 ***<br>...</pre>

<p>The cache timeout could be tuned appropriately by configuring the URL
registry to suite the environment and the needs.</p>

<h2><a name="Sample10">Sample 10:</a></h2>
<pre>&lt;synapse xmlns="http://ws.apache.org/ns/synapse"&gt;
    &lt;!-- introduction dynamic endpoints --&gt;

    &lt;registry provider="org.apache.synapse.registry.url.SimpleURLRegistry"&gt;
        &lt;!-- the root property of the simple URL registry helps resolve a resource URL as root + key --&gt;
        &lt;property name="root" value="file:repository/conf/sample/resources/"/&gt;
        &lt;!-- all resources loaded from the URL registry would be cached for this number of milli seconds --&gt;
        &lt;property name="cachableDuration" value="15000"/&gt;
    &lt;/registry&gt;

    &lt;definitions&gt;
        &lt;endpoint name="dynamic_endpoint" key="endpoint/dynamic_endpt_1.xml"/&gt;
    &lt;/definitions&gt;

    &lt;rules&gt;
        &lt;in&gt;
            &lt;send&gt;
                &lt;endpoint ref="dynamic_endpoint"/&gt;
            &lt;/send&gt;
        &lt;/in&gt;
        &lt;out&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/rules&gt;
&lt;/synapse&gt; </pre>

<p><strong>Objective: Introduction to dynamic endpoints with a
Registry</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Start the Synapse configuration numbered 10: i.e. synapse -sample 10<br>
Start the Axis2 server and deploy the SimpleStockQuoteService and the
SimpleStockQuoteervice1 (Refer steps above)</p>

<p>This example introduces dynamic endpoints, where the definition of an
endpoint is stored in a Registry. To follow this example execute the stock
quote client as 'ant stockquote' and see that the message is routed to the
SimpleStockQuoteService on the Axis2 instance. Repeat the above example and
notice that the endpoint is cached and reused by Synapse - similarly to
example # 8.</p>
<pre>SimpleStockQuoteService :: Generating quote for : IBM</pre>

<p>Now edit the repository/conf/sample/resources/endpoint/dynamic_endpt_1.xml
definition and update the address to
"http://localhost:9000/axis2/services/SimpleStockQuoteService1". After the
cached value expires, the Registry loads the new definition of the endpoint,
and then the messages can be seen being routed to the
SimpleStockQuoteService1.</p>
<pre>SimpleStockQuoteService 1 :: Generating quote for : IBM</pre>

<p></p>

<h2><a name="Sample11">Sample 11:</a></h2>
<pre>&lt;synapse xmlns="http://ws.apache.org/ns/synapse"&gt;

    &lt;!-- a full registry based configuration --&gt;

    &lt;registry provider="org.apache.synapse.registry.url.SimpleURLRegistry"&gt;
        &lt;!-- the root property of the simple URL registry helps resolve a resource URL as root + key --&gt;
        &lt;property name="root" value="file:repository/conf/sample/resources/"/&gt;
        &lt;!-- all resources loaded from the URL registry would be cached for this number of milli seconds --&gt;
        &lt;property name="cachableDuration" value="15000"/&gt;
    &lt;/registry&gt;

&lt;/synapse&gt; </pre>

<p><strong>Objective: A full registry based configuration</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Start the Synapse configuration numbered 11: i.e. synapse -sample 11<br>
Start the Axis2 server and deploy the SimpleStockQuoteService (Refer steps
above)</p>

<p>This example shows a full registry based Synapse configuration. The
Synapse configuration held on a node hosting Synapse simply points to the
registry and looks up the actual configuration by requesting the key
''synapse.xml'. This could be used to host a configuration on a file system
or http server based registry, and allow a cluster of Synapse instances to
load the configuration from this registry.</p>

<p>Using 'ant stockquote' you would notice that the 'synapse.xml'
configuration has been loaded from the root of the Simple URL based
registry.</p>

<p></p>

<h1><a name="WSSecurity">WS-Security</a></h1>

<h2><a name="Sample50">Sample 50:</a></h2>
<pre>&lt;synapse xmlns="http://ws.apache.org/ns/synapse"&gt;

    &lt;!-- Connecting to endpoints with WS-Security for outgoing messages --&gt;
    &lt;definitions&gt;
    &lt;set-property name="sec_policy" src="file:repository/conf/sample/resources/policy/policy_3.xml"/&gt;
    
        &lt;endpoint name="secure" address="http://localhost:9000/axis2/services/SecureStockQuoteService3"&gt;
        &lt;enableSec policy="sec_policy"/&gt;
        &lt;enableAddressing/&gt;
        &lt;/endpoint&gt;
    &lt;/definitions&gt;

    &lt;rules&gt;
    &lt;in&gt;
    &lt;header name="To" value="http://localhost:9000/axis2/services/SecureStockQuoteService3"/&gt;
        &lt;send&gt;
        &lt;endpoint ref="secure"/&gt;
        &lt;/send&gt;
      &lt;/in&gt;
      &lt;out&gt;
      &lt;header name="wsse:Security" action="remove"
                    xmlns:wsse="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd"/&gt;
      &lt;send/&gt;
      &lt;/out&gt;
    &lt;/rules&gt;
&lt;/synapse&gt;</pre>

<p><strong>Objective: Connecting to endpoints with WS-Security for outgoing
messages</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Download and copy the BouncyCastle JAR file into your Synapse lib directory.
(Note: the exact JAR you need to install depends on your JDK - for JDK 1.4 I
have used bcprov-jdk13-132.jar)<br>
</p>

<p>To use the Apache Rampart module, you would also need to ensure that
Xerces has been made available in the Synapse lib directory (e.g.
xercesImpl-2.8.1.jar). You may also need the unlimited strength JDK policy
files for your JDK to be installed (e.g. see
http://java.sun.com/j2se/1.4.2/download.html)</p>
Start the Synapse configuration numbered 50: i.e. synapse -sample 50<br>
Copy the Apache Rampart module (e.g. rampart-1.1-SNAPSHOT.mar) into the
modules directory of the sample Axis2 server
samples/axis2Server/repository/modules. The Rampart module could be found at
repository\modules and is not duplicated within the distributions due to its
large file size.<br>
Start the Axis2 server and deploy the SecureStockQuoteService3 (Refer steps
above) 

<p></p>

<p>Use the stock quote client to send a request without WS-Security. Synapse
is configured to enable WS-Security policy 'policy_3.xml' to the outgoing
message when sent to the SecureStockQuoteService3 service endpoint hosted on
the Axis2 instance. The debug log messages on Synapse shows the encrypted
message flowing to the service and the encrypted response being received by
Synapse. The wsse:Security header is then removed from the decrypted message
and the response is delivered back to the client as it expects.</p>

<p></p>

<p></p>

<p></p>

<h1><a name="ProxyServices">Proxy services</a></h1>

<h2><a name="Sample100">Sample 100:</a></h2>
<pre>&lt;synapse xmlns="http://ws.apache.org/ns/synapse"&gt;

    &lt;!-- introduction to Synapse proxy services. A web service proxy is created and
     hosted on Synapse based on the given WSDL and exposed over all available
     transports for Synapse. If a proxy service should be exposed over only a sub set
     of the available transports, use the transports attribute --&gt;
    &lt;definitions&gt;
        &lt;set-property name="proxy_wsdl" src="file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl"/&gt;
    &lt;/definitions&gt;

    &lt;proxies&gt;
        &lt;proxy name="StockQuoteProxy"&gt;
            &lt;endpoint address="http://localhost:9000/axis2/services/SimpleStockQuoteService"/&gt;
            &lt;publishWSDL key="proxy_wsdl"/&gt;
        &lt;/proxy&gt;
    &lt;/proxies&gt;

    &lt;rules&gt;
        &lt;send/&gt;
        &lt;log&gt;
            &lt;property name="position" value="Inside Main Mediator"/&gt;
        &lt;/log&gt;
    &lt;/rules&gt;

&lt;/synapse&gt;</pre>

<p><strong>Objective: Introduction to Synapse proxy services</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Start the Synapse configuration numbered 100: i.e. synapse -sample 100<br>
Start the Axis2 server and deploy the SimpleStockQuoteService (Refer steps
above)</p>

<p>Once Synapse starts, you could go to
http://localhost:8080/axis2/services/StockQuoteProxy?wsdl and view the WSDL
for the proxy service defined in the configuration. This WSDL is based on the
source WSDL supplied in the proxy service definition, and is updated to
reflect the proxy service EPR.</p>

<p>Execute the stock quote client by requesting for a stock quote on the
proxy service as follows:</p>
<pre>ant stockquote -Durl=http://localhost:8080/axis2/services/StockQuoteProxy</pre>

<p>You will now notice that the message is forwarded to the specified target
endpoint and the request was routed to the SimpleStockQuoteService service on
the local Axis2 instance. The response message is forwarded to the client
with the help of the implicit parameters, as an outgoing sequence is not
specified in this example either. The client should receive a stock quote
reply from the proxy service. Also the client could get the WSDL for the
proxy service by requesting for
http://localhost:8080/axis2/services/StockQuoteProxy?wsdl</p>

<h2><a name="Sample101">Sample 101:</a></h2>
<pre>&lt;synapse xmlns="http://ws.apache.org/ns/synapse"&gt;

    &lt;!-- using custom sequences for incoming and outgoing message mediation with proxy services --&gt;
    &lt;definitions&gt;
        &lt;set-property name="proxy_wsdl" src="file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl"/&gt;

        &lt;sequence name="proxy_1"&gt;
            &lt;send&gt;
                &lt;endpoint address="http://localhost:9000/axis2/services/SimpleStockQuoteService"/&gt;
            &lt;/send&gt;
        &lt;/sequence&gt;

        &lt;endpoint name="proxy_2_endpoint" address="http://localhost:9000/axis2/services/SimpleStockQuoteService"/&gt;

    &lt;/definitions&gt;

    &lt;proxies&gt;
        &lt;proxy name="StockQuoteProxy1"&gt;
            &lt;publishWSDL key="proxy_wsdl"/&gt;
            &lt;target inSequence="proxy_1"/&gt;
        &lt;/proxy&gt;

        &lt;proxy name="StockQuoteProxy2"&gt;
            &lt;publishWSDL key="proxy_wsdl"/&gt;
            &lt;target endpoint="proxy_2_endpoint"/&gt;
        &lt;/proxy&gt;
    &lt;/proxies&gt;

    &lt;rules&gt;
        &lt;send/&gt;
    &lt;/rules&gt;

&lt;/synapse&gt;</pre>

<p><strong>Objective: Using custom sequences and endpoints for message
mediation with proxy services</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Start the Synapse configuration numbered 101: i.e. synapse -sample 101<br>
Start the Axis2 server and deploy the SimpleStockQuoteService (Refer steps
above)</p>

<p>This configuration creates two proxy services with different behaviour.
The first proxy service 'StockQuoteProxy1' uses the sequence named 'proxy_1'
as its main mediation sequence for messages it receives. The second proxy
service 'StockQuoteProxy2' is set to directly forward messages that are
received to the endpoint named 'proxy_2_endpoint' without any mediation.</p>

<p>You could send a stock quote request to each of these proxy services and
receive the reply generated by the actual service hosted on the Axis2
instance. Use the -Durl=&lt;EPR&gt; property when executing the client as per
example 100, to request on the two proxy services.</p>

<h2><a name="Sample102">Sample 102:</a></h2>
<pre>&lt;synapse xmlns="http://ws.apache.org/ns/synapse"&gt;

    &lt;!-- attaching service level WS-Security policies to proxy services --&gt;
    &lt;definitions&gt;
        &lt;set-property name="proxy_wsdl"
                      src="file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl"/&gt;
        &lt;set-property name="sec_policy"
                      src="file:repository/conf/sample/resources/policy/policy_1.xml"/&gt;
    &lt;/definitions&gt;

    &lt;proxies&gt;
        &lt;proxy name="StockQuoteProxy"&gt;
            &lt;target&gt;
                &lt;inSequence&gt;
                    &lt;header name="wsse:Security" action="remove"
                            xmlns:wsse="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd"/&gt;
                    &lt;send&gt;
                        &lt;endpoint address="http://localhost:9000/axis2/services/SimpleStockQuoteService"/&gt;
                    &lt;/send&gt;
                &lt;/inSequence&gt;
            &lt;/target&gt;
            &lt;publishWSDL key="proxy_wsdl"/&gt;
            &lt;policy key="sec_policy"/&gt;
        &lt;/proxy&gt;
    &lt;/proxies&gt;

    &lt;rules&gt;
        &lt;in&gt;
            &lt;header name="wsse:Security" action="remove"
                    xmlns:wsse="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd"/&gt;
            &lt;send&gt;
                &lt;endpoint address="http://localhost:9000/axis2/services/SimpleStockQuoteService"/&gt;
            &lt;/send&gt;
        &lt;/in&gt;
        &lt;out&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/rules&gt;

&lt;/synapse&gt;</pre>

<p><strong>Objective: Attaching service level WS-Security policies to proxy
services</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Start the Synapse configuration numbered 102: i.e. synapse -sample 102</p>

<p>Copy the Apache Rampart module (e.g. rampart-1.1-SNAPSHOT.mar) into the
modules directories of both the sample Axis2 client and server:
samples/axis2Client/client_repo/modules and
samples/axis2Server/repository/modules. The Rampart module could be found at
repository\modules and is not duplicated in the distributions due to its
large file size.</p>

<p>Start the Axis2 server and deploy the SimpleStockQuoteService (Refer steps
above)</p>

<p>To execute the sample use the stock quote client with the 'secpolicy' and
'url' system properties passed in as follows:</p>

<p>e.g.</p>
<pre>ant stockquote -Durl=http://localhost:8080/axis2/services/StockQuoteProxy -Dsecpolicy=..\..\repository\conf\sample\resources\policy\policy_1.xml</pre>

<p>The sample security policy policy_1.xml uses timestamps and username token
tuhentication on the stock quote request. Following the debug logs on the
Synapse server you could notice the presence of WS-Security headers on the
incoming message. By requesting the WSDL of the proxy service you could also
see that the supplied policy file has been attached to the specified WSDL as
well.</p>

<p>e.g. http://localhost:8080/axis2/services/StockQuoteProxy?wsdl</p>

<p>A proxy service with an attached policy - such as a WS-Security policy -
ensures that messages which goes through mediation have satisfied the
constraints as specified by the supplied policy. i.e. for example, if any
WS-Security validations fail, the message will not reach Synapse mediation,
but the client would get an appropriate error message from the Apache Rampart
module directly.</p>

<p>The mediation shows the header mediator used to strip out the
wsse:Security header from the current message before being forwarded to the
SimpleStockQuoteService. Hence the message sent to the stock quote service
EPR is without any WS-Security headers as can be seen from the log
messages.</p>

<h2><a name="Sample103">Sample 103:</a></h2>
<pre>&lt;synapse xmlns="http://ws.apache.org/ns/synapse"&gt;

    &lt;!-- attaching service level WS-Security policies to proxy services --&gt;
    &lt;definitions&gt;
        &lt;set-property name="proxy_wsdl"
                      src="file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl"/&gt;
        &lt;set-property name="sec_policy"
                      src="file:repository/conf/sample/resources/policy/policy_3.xml"/&gt;
    &lt;/definitions&gt;

    &lt;proxies&gt;
        &lt;proxy name="StockQuoteProxy"&gt;
            &lt;target&gt;
                &lt;inSequence&gt;
                    &lt;header name="wsse:Security" action="remove"
                            xmlns:wsse="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd"/&gt;
                    &lt;send&gt;
                        &lt;endpoint address="http://localhost:9000/axis2/services/SimpleStockQuoteService"/&gt;
                    &lt;/send&gt;
                &lt;/inSequence&gt;
            &lt;/target&gt;
            &lt;publishWSDL key="proxy_wsdl"/&gt;
            &lt;policy key="sec_policy"/&gt;
        &lt;/proxy&gt;
    &lt;/proxies&gt;

    &lt;rules&gt;
        &lt;in&gt;
            &lt;header name="wsse:Security" action="remove"
                    xmlns:wsse="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd"/&gt;
            &lt;send&gt;
                &lt;endpoint address="http://localhost:9000/axis2/services/SimpleStockQuoteService"/&gt;
            &lt;/send&gt;
        &lt;/in&gt;
        &lt;out&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/rules&gt;

&lt;/synapse&gt;</pre>

<p><strong>Objective: Using WS-Security signing and encryption with proxy
services through WS-Policy</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Download and copy the BouncyCastle JAR and the Xalan JAR file into your
Synapse lib directory. (Note: the exact BouncyCastle JAR you need to install
depends on your JDK - for JDK 1.4 I have used bcprov-jdk13-132.jar and the
xalan-2.7.0.jar)<br>
Start the Synapse configuration numbered 103: i.e. synapse -sample 103<br>
Copy the Apache Rampart module (e.g. rampart-1.1-SNAPSHOT.mar) into the
modules directory of the sample Axis2 client
samples/axis2Client/client_repo/modules. The Rampart module could be found at
repository\modules and is not duplicated within the distributions due to its
large file size.<br>
Start the Axis2 server and deploy the SimpleStockQuoteService (Refer steps
above)</p>

<p>To execute the sample use the dumb stock quote client with the 'secpolicy'
and 'gatewayurl' system properties passed in as follows:</p>

<p>e.g.</p>
<pre>ant dumbstockquote -Dsecpolicy=..\..\repository\conf\sample\resources\policy\client_policy_3.xml -Dgatewayurl=http://localhost:8080/axis2/services/StockQuoteProxy</pre>

<p>The sample security policy client_policy_3.xml ensures signed and
encrypted messages which request for the stock quotes. Following the debug
logs on the Synapse server you could notice the presence of WS-Security
headers on the incoming message. By requesting the WSDL of the proxy service
you could also see that the supplied policy file has been attached to the
specified WSDL as well.</p>

<p>e.g. http://localhost:8080/axis2/services/StockQuoteProxy?wsdl</p>

<p>By following through the Synapse log messages you could see that the proxy
service received and decrypted the secured SOAP envelope. (If you sent the
client request to Synapse through a TCP monitor you would be able to see the
raw encrypted message in transit) and forwarded this to the simple stockquote
service, and once the response was received, signed it and encrypted it
before sending it back to the client.</p>

<p>Using TCPMon, a sample request sent from the client to the WS-Security
enabled proxy service has been captured as follows: <a
href="sample_103_1.txt?content-type=text&amp;view=co">sample_103_1.txt</a></p>

<p>Synapse removes the wsse:Security header from this message and forwards it
to the endpoint. The response received is now signed and encrypted and sent
back to the client as follows: <a
href="sample_103_2.txt?content-type=text&amp;view=co">sample_103_2.txt</a></p>

<h2><a name="Sample104">Sample 104:</a></h2>
<pre>&lt;synapse xmlns="http://ws.apache.org/ns/synapse"&gt;

    &lt;!-- using custom sequences for incoming and outgoing message mediation with proxy services --&gt;
    &lt;definitions&gt;
        &lt;set-property name="proxy_wsdl" src="file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl"/&gt;

        &lt;sequence name="proxy_in"&gt;
            &lt;send&gt;
                &lt;endpoint address="http://localhost:9000/axis2/services/SimpleStockQuoteService"/&gt;
            &lt;/send&gt;
        &lt;/sequence&gt;

        &lt;sequence name="proxy_out"&gt;
            &lt;log level="custom"&gt;
                &lt;property name="message" value="Executing inside the out sequence"/&gt;
            &lt;/log&gt;
            &lt;send/&gt;
        &lt;/sequence&gt;

    &lt;/definitions&gt;

    &lt;proxies&gt;
        &lt;proxy name="StockQuoteProxy"&gt;
            &lt;publishWSDL key="proxy_wsdl"/&gt;
            &lt;target inSequence="proxy_in" outSequence="proxy_out"/&gt;
        &lt;/proxy&gt;
    &lt;/proxies&gt;

    &lt;rules&gt;
        &lt;send/&gt;
    &lt;/rules&gt;

&lt;/synapse&gt;</pre>

<p><strong>Objective: Using an explicit out sequence in proxy service level
to mediate proxy response</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Start the Synapse configuration numbered 104: i.e. synapse -sample 104 <br>
Start the Axis2 server and deploy the SimpleStockQuoteService (Refer steps
above)</p>

<p>This configuration creates a proxy service with the name StockQuoteProxy.
This proxy service specifies both inSequence and the outSequence for that
service. This will add a proxy level out sequence to be used for the response
message mediation of that particular proxy service.</p>

<p>You could send a stock quote request to this proxy services and receive
the reply generated by the actual service hosted on the Axis2 instance. Use
the -Durl=&lt;EPR&gt; property when executing the client as per example 100,
to request on this proxy service.</p>

<p>You can observe the synapse log to see the response message mediation
using the specified outSequence, unlike using MainMediator in the sample 100
case. The log should be as follows</p>
<pre>DEBUG SequenceMediator - Sequence mediator &lt;proxy_out&gt; :: mediate()
DEBUG AbstractListMediator - Implicit Sequence &lt;SequenceMediator&gt; :: mediate()
DEBUG LogMediator - Log mediator :: mediate()
INFO  LogMediator - message = Executing inside the out sequence</pre>

<h2>Sample 105:</h2>
<pre>&lt;synapse xmlns="http://ws.apache.org/ns/synapse"&gt;

    &lt;!-- demonstrate JMS raw Text / POX message support --&gt;
    &lt;definitions&gt;
        &lt;sequence name="text_proxy"&gt;
            &lt;header name="Action" value="urn:placeOrder"/&gt;
            &lt;script.js&gt;&lt;![CDATA[
               var args = mc.getPayloadXML().toString().split(" ");
               mc.setPayloadXML(
                &lt;m:placeOrder xmlns:m="http://services.samples/xsd"&gt;
                    &lt;m:order&gt;
                        &lt;m:price&gt;{args[0]}&lt;/m:price&gt;
                        &lt;m:quantity&gt;{args[1]}&lt;/m:quantity&gt;
                        &lt;m:symbol&gt;{args[2]}&lt;/m:symbol&gt;
                    &lt;/m:order&gt;
                &lt;/m:placeOrder&gt;);
            ]]&gt;&lt;/script.js&gt;
            &lt;send&gt;
                &lt;endpoint address="http://localhost:9000/axis2/services/SimpleStockQuoteService"/&gt;
            &lt;/send&gt;
        &lt;/sequence&gt;

        &lt;sequence name="mtom_proxy"&gt;
            &lt;header name="Action" value="urn:uploadFileUsingMTOM"/&gt;
            &lt;send&gt;
                &lt;endpoint address="http://localhost:9000/axis2/services/MTOMSampleService" optimize="mtom"/&gt;
            &lt;/send&gt;
        &lt;/sequence&gt;

        &lt;sequence name="pox_proxy"&gt;
            &lt;header name="Action" value="urn:placeOrder"/&gt;
            &lt;send&gt;
                &lt;endpoint address="http://localhost:9000/axis2/services/SimpleStockQuoteService" force="soap"/&gt;
            &lt;/send&gt;
        &lt;/sequence&gt;
    &lt;/definitions&gt;

    &lt;proxies&gt;
        &lt;proxy name="JMSFileUploadProxy" transports="jms"&gt;
            &lt;target inSequence="mtom_proxy"/&gt;
            &lt;parameter name="transport.jms.Wrapper"&gt;{http://services.samples/xsd}element&lt;/parameter&gt;
        &lt;/proxy&gt;
        &lt;proxy name="JMSTextProxy" transports="jms"&gt;
            &lt;target inSequence="text_proxy"/&gt;
            &lt;parameter name="transport.jms.Wrapper"&gt;{http://services.samples/xsd}text&lt;/parameter&gt;
        &lt;/proxy&gt;
        &lt;proxy name="JMSPoxProxy" transports="jms"&gt;
            &lt;target inSequence="pox_proxy"/&gt;
        &lt;/proxy&gt;
    &lt;/proxies&gt;

    &lt;rules&gt;
    &lt;log level="full"/&gt;
    &lt;drop/&gt;
    &lt;/rules&gt;

&lt;/synapse&gt;</pre>

<p><strong>Objective: Pure POX/Text and Binary JMS Proxy services - including
MTOM</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Configure JMS for Synapse (Refer notes above)<br>
Configure the script mediator runtime (Refer notes below)<br>
i.e. make bsf-2.4.0.jar, xbean-2.2.0.jar and js-1.6R2.jar available in lib
folder)<br>
Configure Synapse and the sample Axis2 server to use MTOM (i.e. set
enableMTOM parameter to true)<br>
Start the Synapse configuration numbered 105: i.e. synapse -sample 105<br>
Start the Axis2 server and deploy the SimpleStockQuoteService and the
MTOMSampleService (Refer steps above)</p>

<p>This configuration creates three JMS proxy services named
JMSFileUploadProxy, JMSTextProxy and JMSPoxProxy exposed over JMS queues with
the same names. The first part of this example demonstrates the pure text
message support with JMS, where a user sends a text JMS message of the form
"&lt;price&gt; &lt;qty&gt; &lt;symbol&gt;". Synapse converts this message
into a SOAP message and sends this to the SimpleStockQuoteServices'
placeOrder operation. The mediation uses the script mediator to transform the
text message into a XML payload. The proxy service property named
"transport.jms.Wrapper" defines the wrapper element QName, to be used when
wrapping text/binary content into a SOAP envelope.</p>

<p></p>

<p>Execute ' ant jmsclient -Dpayload="24.34 100 IBM"' which executes the
first scenario. The client sends a JMS text message with the specified
payload to the specified destination. Though the debug logs, you could see
that Synapse received a text message over JMS and converted this to a SOAP
message and sent it to the SimpleStockQuoteService as follows</p>
<pre>[JMSWorker-1] DEBUG ProxyServiceMessageReceiver - Proxy Service JMSTextProxy received a new message...
[JMSWorker-1] DEBUG ProxyServiceMessageReceiver - Body :
&lt;?xml version='1.0' encoding='utf-8'?&gt;&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"&gt;
&lt;soapenv:Header /&gt;&lt;soapenv:Body&gt;&lt;axis2ns3:text xmlns:axis2ns3="http://services.samples/xsd"&gt;
65.05119159089897 6079 IBM&lt;/axis2ns3:text&gt;&lt;/soapenv:Body&gt;&lt;/soapenv:Envelope&gt;
..
[JMSWorker-1] DEBUG SendMediator - Sending message to endpoint :: name = null 
resolved address = http://localhost:9000/axis2/services/SimpleStockQuoteService
&lt;?xml version='1.0' encoding='utf-8'?&gt;&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"&gt;
&lt;soapenv:Header /&gt;&lt;soapenv:Body&gt;&lt;m:placeOrder xmlns:m="http://services.samples/xsd"&gt;&lt;m:order&gt;
&lt;m:price&gt;65.05119159089897&lt;/m:price&gt;&lt;m:quantity&gt;6079&lt;/m:quantity&gt;&lt;m:symbol&gt;IBM&lt;/m:symbol&gt;&lt;/m:order&gt;&lt;/m:placeOrder&gt;&lt;/soapenv:Body&gt;&lt;/soapenv:Envelope?</pre>

<p>The next section uses the 'ant jmsclient -Dtype=binary
-Ddest=dynamicQueues/JMSFileUploadProxy
-Dpayload=.\..\..\repository\conf\sample\resources\mtom\asf-logo.gif" which
sends a JMS bytes message to the defined destination with the content of the
payload file as its body. Synapse receives the bytes message and creates a
SOAP envelope. If the axis2.xml used by Synapse enables MTOM optimization
(through the 'enableMTOM' parameter), then Synapse sends an MTOM optimized
message to the endpoint as follows, else it encodes the content as Base64:</p>

<p></p>
<pre>POST /axis2/services/MTOMSampleService HTTP/1.1
SOAPAction: "urn:uploadFileUsingMTOM"
User-Agent: Axis2Host: 127.0.0.1
Content-Length: 8528
Content-Type: multipart/related; boundary=MIMEBoundaryurn_uuid_3FE7ADC48E69671C2211646391275465; type="application/xop+xml"; 
start="&lt;0.urn:uuid:3FE7ADC48E69671C2211646391275466@apache.org&gt;"; start-info="text/xml"; charset=UTF-8--MIMEBoundaryurn_uuid_3FE7ADC48E69671C2211646391275465
content-type: application/xop+xml;
 charset=UTF-8; type="text/xml";content-transfer-encoding: binarycontent-id:&lt;0.urn:uuid:3FE7ADC48E69671C2211646391275466@apache.org&gt;
&lt;?xml version='1.0' encoding='UTF-8'?&gt;&lt;soapenv:Envelope xmlns:wsa="http://www.w3.org/2005/08/addressing" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"&gt;
&lt;soapenv:Header&gt;...&lt;/soapenv:Header&gt;&lt;soapenv:Body&gt;&lt;axis2ns2:element 
xmlns:axis2ns2="http://services.samples/xsd"&gt;&lt;xop:Include href="cid:1.urn:uuid:3FE7ADC48E69671C2211646391275464@apache.org" xmlns:xop="http://www.w3.org/2004/08/xop/include"
 /&gt;&lt;/axis2ns2:element&gt;
&lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;--MIMEBoundaryurn_uuid_3FE7ADC48E69671C2211646391275465content-type: application/octet-streamcontent-transfer-encoding: binarycontent-id:
&lt;1.urn:uuid:3FE7ADC48E69671C2211646391275464@apache.org&gt;GIF89a&#x192;d.... ;--MIMEBoundaryurn_uuid_3FE7ADC48E69671C2211646391275465-</pre>

<p>The final section of this example shows a POX JMS message received by
Synapse and sent to the SimpleStockQuoteService as a SOAP message. Execute
this scenario as 'ant jmsclient -Dtype=xml -Ddest=dynamicQueues/JMSPoxProxy
-Dpayload=MSFT' and notice that since the message received by Synapse is POX,
you need to force a SOAP message out through the endpoint in-order for the
SimpleStockQuoteService to properly receive its response. In this example
Synapse wraps the received POX message in a SOAP envelope and processes it
and routes it to the real endpoint.</p>

<p></p>

<p>// TODO - REST to WS sample</p>
<pre>&lt;syn:synapse xmlns:syn="http://ws.apache.org/ns/synapse"&gt;
    &lt;syn:proxies&gt;
        &lt;syn:proxy name="StockQuoteProxy" startOnLoad="true"/&gt;
    &lt;/syn:proxies&gt;
    &lt;syn:rules&gt;
        &lt;syn:in&gt;
            &lt;syn:header name="Action" value="urn:getQuote"/&gt;
            &lt;syn:send&gt;
                &lt;syn:endpoint force="soap" address="http://localhost:9001/axis2/services/SimpleStockQuoteService"/&gt;
            &lt;/syn:send&gt;
        &lt;/syn:in&gt;
        &lt;syn:out&gt;
            &lt;syn:send/&gt;
        &lt;/syn:out&gt;
    &lt;/syn:rules&gt;
&lt;/syn:synapse&gt;</pre>

<h1><a name="Transports1" id="Transports1">Transports</a></h1>

<h2><a name="Sample110">Sample 110:</a></h2>
<pre>&lt;synapse xmlns="http://ws.apache.org/ns/synapse"&gt;

    &lt;!-- attaching service level WS-Security policies to proxy services --&gt;
    &lt;definitions&gt;
        &lt;set-property name="proxy_wsdl"
                      src="file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl"/&gt;
    &lt;/definitions&gt;

    &lt;proxies&gt;
        &lt;proxy name="StockQuoteProxy" transports="jms"&gt;
            &lt;wsdl key="proxy_wsdl"/&gt;
        &lt;/proxy&gt;
    &lt;/proxies&gt;

    &lt;rules&gt;
        &lt;in&gt;
            &lt;send&gt;
                &lt;endpoint address="http://localhost:9000/axis2/services/SimpleStockQuoteService"/&gt;
            &lt;/send&gt;
        &lt;/in&gt;
        &lt;out&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/rules&gt;

&lt;/synapse&gt;</pre>

<p><strong>Objective: Introduction to switching transports with proxy
services</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Start the Axis2 server and deploy the SimpleStockQuoteService (Refer steps
above)<br>
Download, install and start a JMS server, and configure Synapse to listen on
JMS (refer notes below)<br>
Start the Synapse configuration numbered 110: i.e. synapse -sample 110<br>
For this example we would use ActiveMQ as the JMS provider. Once ActiveMQ is
installed and started you should get a message as follows:</p>
<pre>INFO BrokerService - ActiveMQ JMS Message Broker (localhost) started</pre>

<p>You will now need to configure the Axis2 instance used by Synapse (not the
sample Axis2 server) to enable JMS support using the above provider. Refer to
the Axis2 documentation on setting up JMS for more details
(http://ws.apache.org/axis2/1_1/jms-transport.html). You will also need to
copy the ActiveMQ client jar files activeio-core-3.0-beta1.jar,
activemq-core-4.0-RC2.jar, geronimo-jms_1.1_spec-1.0.jar and
geronimo-j2ee-management_1.0_spec-1.0.jar into the lib directory to allow
Synapse to connect to the JMS provider.</p>

<p>For a default ActiveMQ v4.0 installation, you may uncomment the Axis2
transport listener configuration found at repository/conf/axis2.xml as</p>
<pre>&lt;transportReceiver name="jms" class="org.apache.axis2.transport.jms.JMSListener"&gt; ...</pre>

<p>Once you start the Synapse configuration and request for the WSDL of the
proxy service you will notice that its exposed only on the JMS transport.
This is because the configuration specified this requirement in the proxy
service definition.</p>

<p>Now lets send a stock quote request on JMS, using the dumb stock quote
client as follows:</p>
<pre>ant dumbstockquote -Dgatewayurl="jms:/StockQuoteProxy?transport.jms.ConnectionFactoryJNDIName=
QueueConnectionFactory&amp;java.naming.factory.initial=org.apache.activemq.jndi.
ActiveMQInitialContextFactory&amp;java.naming.provider.url=tcp://localhost:61616"</pre>

<p>On the Synapse debug log you will notice that the JMS listener received
the request message as:</p>
<pre>[JMSWorker-1] DEBUG ProxyServiceMessageReceiver -Proxy Service StockQuoteProxy received a new message...</pre>

<p>Synapse forwarded this message to the HTTP EPR of the simple stock quote
service hosted on the sample Axis2 server, and returned the reply back to the
client through a JMS temporary queue.</p>

<p>Note: It is possible to instruct a JMS proxy service to listen to an
already existing destination without creating a new one. To do this, use the
property elements on the proxy service definition to specify the destination
and connection factory etc.</p>

<p>e.g.</p>
<pre>&lt;property name="transport.jms.Destination" value="dynamicTopics/something.TestTopic"/&gt;</pre>

<h2><a name="Sample111">Sample 111:</a></h2>
<pre>&lt;synapse xmlns="http://ws.apache.org/ns/synapse"&gt;

    &lt;!-- attaching service level WS-Security policies to proxy services --&gt;
    &lt;definitions&gt;
        &lt;set-property name="proxy_wsdl"
                      src="file:repository/conf/sample/resources/proxy/sample_proxy_1.wsdl"/&gt;
    &lt;/definitions&gt;

    &lt;proxies&gt;
        &lt;proxy name="StockQuoteProxy" transports="http"&gt;
            &lt;wsdl key="proxy_wsdl"/&gt;
        &lt;/proxy&gt;
    &lt;/proxies&gt;

    &lt;rules&gt;
        &lt;in&gt;
            &lt;send&gt;
                &lt;endpoint address="jms:/SimpleStockQuoteService?transport.jms.ConnectionFactoryJNDIName=
                           QueueConnectionFactory&amp;amp;java.naming.factory.initial=org.apache.activemq.jndi.ActiveMQInitialContextFactory&amp;
                           amp;java.naming.provider.url=tcp://localhost:61616"/&gt;
            &lt;/send&gt;
        &lt;/in&gt;
        &lt;out&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/rules&gt;

&lt;/synapse&gt;</pre>

<p><strong>Objective: Demonstrate switching from HTTP to JMS</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Download, install and start a JMS server, and configure Synapse to listen on
JMS (refer notes below)<br>
Configure sample Axis2 server for JMS (refer notes above)<br>
Start the Axis2 server and deploy the SimpleStockQuoteService (Refer steps
above)<br>
Configure JMS transport for Synapse (refer notes above - sample 110)<br>
Start the Synapse configuration numbered 111: i.e. synapse -sample 111</p>

<p>To switch from HTTP to JMS, edit the
samples/axis2Server/repository/conf/axis2.xml for the sample Axis2 server and
enable JMS (refer notes above), and restart the server. You should now see
that the simple stock quote service is available over JMS as well at an
address as the one shown below, by looking at the WSDL of the service.</p>
<pre>jms:/SimpleStockQuoteService?transport.jms.ConnectionFactoryJNDIName=
QueueConnectionFactory&amp;java.naming.factory.initial=org.apache.activemq.jndi.ActiveMQInitialContextFactory&amp;
java.naming.provider.url=tcp://localhost:61616</pre>

<p>This Synapse configuration creates a proxy service over HTTP and forwards
received messages to the above EPR using JMS, and sends back the response to
the client over HTTP once the simple stock quote service responds with the
stock quote reply over JMS to the Synapse server.</p>

<p></p>

<h2><a name="Sample112">Sample 112:</a></h2>

<p><strong>Objective: Demonstrate one way messaging /
fireAndForget()</strong></p>

<p><strong>Pre-Requisites:</strong><br>
Start the Axis2 server and deploy the SimpleStockQuoteService (Refer steps
above)<br>
Start the Synapse configuration numbered 1: i.e. synapse -sample 1</p>

<p>This example invokes the one-way 'placeOrder' operation on the
SimpleStockQuoteService using the custom client which uses the Axis2
ServiceClient.fireAndForget() API. To test this, use 'ant placeorder' and you
will notice the one way message flowing through Synapse into the sample Axis2
server instance, which reports the acceptance of the order as follows:</p>
<pre>SimpleStockQuoteService :: Accepted order for : 7482 stocks of IBM at $ 169.27205579038733</pre>

<p>If you send your client request through TCPmon, you will notice that the
SimpleStockQuoteService replies to Synapse with a HTTP 202 reply, and that
Synapse in-turn replies to the client with a HTTP 202 acknowledgement.</p>

<h1><a name="ScriptMediators">Script mediators</a></h1>

<p>Synapse supports Mediators implemented in a variety of scripting languages
such as JavaScript, Python or Ruby.</p>

<p>Implementing a Mediator with a script language can have advantages over
using the built in Synapse Mediator types or implementing a custom Java class
Mediator. Script Mediators have all the flexibility of a class Mediator with
access to the Synapse MessageContext and SynapseEnvironment APIs, and the
ease of use and dynamic nature of scripting languages allows rapid
development and prototyping of custom mediators. An additional benefit of
some scripting languages is that they have very simple and elegant XML
manipulation capabilities, for example JavaScript E4X or Ruby REXML, so this
makes them well suited for use in the Synapse mediation environment.</p>

<h2><a name="ScriptSetup">Configuring Synapse for Script Mediator
support</a></h2>

<p>The Synapse Script Mediator is a Synapse extension so all its pre-reqs are
not installed by default. Before you use script mediators you need to
manually add the required jars to the Synapse lib directory and do any other
installation that may be required by the individual scripting languages. This
is detailed in the following sections. </p>

<h3><a name="ScriptSetupJavaScript">JavaScript support</a></h3>

<p>For JavaScript/E4X support you need to copy the following jars to the
Synapse lib directory:</p>
<ul>
  <li><a
    href="http://repo1.maven.org/maven2/bsf/bsf/2.4.0/bsf-2.4.0.jar">Apache
    BSF</a></li>
  <li><a
    href="http://repo1.maven.org/maven2/rhino/js/1.6R5/js-1.6R5.jar">Mozilla
    Rhino</a></li>
  <li><a
    href="http://repo1.maven.org/maven2/xmlbeans/xbean/2.2.0/xbean-2.2.0.jar">XmlBeans
    xbean</a></li>
</ul>

<p>(Note: You should be able to right click on those links and save the jars
directly to your Synapse lib directory)</p>

<h3><a name="ScriptSetupRuby">Ruby support</a></h3>

<p>For Ruby support you need to copy the following jars to the Synapse lib
directory:</p>
<ul>
  <li><a
    href="http://repo1.maven.org/maven2/bsf/bsf/2.4.0/bsf-2.4.0.jar">Apache
    BSF</a></li>
  <li><a
    href="http://repo1.maven.org/maven2/org/jruby/jruby/0.9.1/jruby-0.9.1.jar">JRuby</a></li>
</ul>

<p>(Note: You should be able to right click on those links and save the jars
directly to your Synapse lib directory)</p>

<p>In addition to those jars, to use the REXML capabilities of Ruby requires
a complete JRuby installation. Download and install JRuby from <a
href="http://dist.codehaus.org/jruby/">JRuby Home</a>. Once installed you
need to tell Synapse about the instalation by setting a system property when
starting Synapse. Right now this requires manually editing the Synapse
startup script (this will be improved in a future Synapse release). Edit the
bin\synapse.bat file and at the bottom find the line starting ""%_JAVACMD%"
%_SYNAPSE_XML%" and insert the system property -Djruby.home="&lt;path to your
JRuby install directory&gt;". Note the quote characters around the JRuby
directory which are required. </p>

<h2><a name="Sample500">Sample 500:</a></h2>
<pre>&lt;synapse xmlns="http://ws.apache.org/ns/synapse"&gt;

    &lt;!-- Introduction to the script mediator --&gt;

    &lt;definitions&gt;

        &lt;!-- define a static property for the JavaScript source code file --&gt;
        &lt;set-property name="stockquoteScript" src="file:repository/conf/sample/resources/script/stockquoteTransform.js"/&gt;

        &lt;!-- define a reuseable endpoint definition and use it within config --&gt;
        &lt;endpoint name="stockquote" address="http://localhost:9000/axis2/services/SimpleStockQuoteService"/&gt;

    &lt;/definitions&gt;

    &lt;rules&gt;
        &lt;in&gt;
            &lt;!-- transform the custom quote request into a standard quote request expected by the service --&gt;
            &lt;script key="stockquoteScript" function="transformRequest"/&gt;

            &lt;!-- send message to real endpoint referenced by name "stockquote" and stop --&gt;
            &lt;send&gt;
                &lt;endpoint ref="stockquote"/&gt;
            &lt;/send&gt;
        &lt;/in&gt;

        &lt;out&gt;
            &lt;!-- transform the standard response back into the custom format the client expects --&gt;
            &lt;script key="stockquoteScript" function="transformResponse"/&gt;

            &lt;!-- now send the custom response back to the client and stop --&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/rules&gt;

&lt;/synapse&gt; </pre>

<p><strong>Objective: Introduction to script mediators</strong></p>

<p>This sample is similar to sample 8 but instead of using XSLT the
transformation is done with JavaScript and E4X</p>

<p>The Synapse config XML for this is <a
href="../repository/conf/sample/synapse_sample_500.xml"
type="text/txt">synapse_sample_500.xml</a> and the associated JavaScript
program is <a
href="../repository/conf/sample/resources/script/stockquoteTransform.js"
type="text/txt">stockquoteTransform.js</a>.</p>

<p><strong>Pre-Requisites:</strong></p>

<p>This sample uses JavaScript/E4X so first setup support for this in Synapse
as described at <a href="#ScriptSetupJavaScript">Configuring JavaScript</a>.
</p>

<p>Start the Synapse configuration numbered 500: i.e. synapse -sample 500<br>
Start the Axis2 server and deploy the SimpleStockQuoteService (Refer steps
above)</p>

<p>The JavaScript script is in a separate file which the Synapse xml
references by using a static property named 'stockquoteScript'. The script
has two functions, 'transformRequest' and 'transformResponse', and the
Synapse xml script element uses the function attribute to specify which
function to use for the in and out rules.</p>

<p>Execute the custom quote client as 'ant customquote' and check analyze the
the Synapse debug log output as shown below</p>
<pre>DEBUG XSLTMediator - Transformation source :&lt;m0:CheckPriceRequest xmlns:m0=http://www.apache-synapse.org/test&gt;
&lt;m0:Code&gt;IBM&lt;/m0:Code&gt;&lt;/m0:CheckPriceRequest&gt;
DEBUG XSLTMediator - Transformation result :
&lt;m:getQuote xmlns:m=http://services.samples/xsd&gt;
&lt;m:request&gt;&lt;m:symbol&gt;IBM&lt;/m:symbol&gt;&lt;/m:request&gt;&lt;/m:getQuote&gt;</pre>

<p>The incoming message is now transformed into a standard stock quote
request as expected by the SimpleStockQuoteService deployed on the local
Axis2 instance by the JavaScript mediator. The JavaScript mediator uses E4X
to perform the transformations. The response from the SimpleStockQuoteService
is converted into the custom format as expected by the client during the out
message processing.</p>

<h2><a name="Sample501">Sample 501:</a></h2>
<pre>&lt;synapse xmlns="http://ws.apache.org/ns/synapse"&gt;

    &lt;!-- Introduction to the script mediator using in-line scripts --&gt;

    &lt;definitions&gt;

        &lt;!-- define a reuseable endpoint definition and use it within config --&gt;
        &lt;endpoint name="stockquote" address="http://localhost:9000/axis2/services/SimpleStockQuoteService"/&gt;

    &lt;/definitions&gt;

    &lt;rules&gt;
        &lt;in&gt;
            &lt;!-- transform the custom quote request into a standard quote requst expected by the service --&gt;
            &lt;script.js&gt;&lt;![CDATA[
               var symbol = mc.getPayloadXML()..*::Code.toString();
               mc.setPayloadXML(
                  &lt;m:getQuote xmlns:m="http://services.samples/xsd"&gt;
                     &lt;m:request&gt;
                        &lt;m:symbol&gt;{symbol}&lt;/m:symbol&gt;
                     &lt;/m:request&gt;
                  &lt;/m:getQuote&gt;);
            ]]&gt;&lt;/script.js&gt;

            &lt;!-- send message to real endpoint referenced by name "stockquote" and stop --&gt;
            &lt;send&gt;
                &lt;endpoint ref="stockquote"/&gt;
            &lt;/send&gt;
        &lt;/in&gt;

        &lt;out&gt;
            &lt;!-- transform the standard response back into the custom format the client expects --&gt;
            &lt;script.js&gt;&lt;![CDATA[
               var symbol = mc.getPayloadXML()..*::symbol.toString();
               var price = mc.getPayloadXML()..*::last.toString();
               mc.setPayloadXML(
                  &lt;m:CheckPriceResponse xmlns:m="http://www.apache-synapse.org/test"&gt;
               &lt;m:Code&gt;{symbol}&lt;/m:Code&gt;
               &lt;m:Price&gt;{price}&lt;/m:Price&gt;
                  &lt;/m:CheckPriceResponse&gt;);
            ]]&gt;&lt;/script.js&gt;

            &lt;!-- now send the custom response back to the client and stop --&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/rules&gt;

&lt;/synapse&gt; </pre>

<p><strong>Objective: Introduction to in-line script mediators</strong></p>

<p>This sample is the same as sample 500 but instead of having the JavaScript
source defined in a separate file it is defined in-line within the Synapse
XML.</p>

<p>The Synapse config XML for this is <a
href="../repository/conf/sample/synapse_sample_501.xml"
type="text/txt">synapse_sample_501.xml</a>.</p>

<p><strong>Pre-Requisites:</strong></p>

<p>This sample uses JavaScript/E4X so first setup support for this in Synapse
as described at <a href="#ScriptSetupJavaScript">Configuring JavaScript</a>.
</p>

<p>Start the Synapse configuration numbered 501: i.e. synapse -sample 501<br>
Start the Axis2 server and deploy the SimpleStockQuoteService (Refer steps
above)</p>

<p>Execute the custom quote client as 'ant customquote' and check analyze the
the Synapse debug log output as shown below</p>
<pre>DEBUG XSLTMediator - Transformation source :&lt;m0:CheckPriceRequest xmlns:m0=http://www.apache-synapse.org/test&gt;
&lt;m0:Code&gt;IBM&lt;/m0:Code&gt;&lt;/m0:CheckPriceRequest&gt;
DEBUG XSLTMediator - Transformation result :
&lt;m:getQuote xmlns:m=http://services.samples/xsd&gt;
&lt;m:request&gt;&lt;m:symbol&gt;IBM&lt;/m:symbol&gt;&lt;/m:request&gt;&lt;/m:getQuote&gt;</pre>

<p>The incoming message is now transformed into a standard stock quote
request as expected by the SimpleStockQuoteService deployed on the local
Axis2 instance by the JavaScript mediator. The JavaScript mediator uses E4X
to perform the transformations. The response from the SimpleStockQuoteService
is converted into the custom format as expected by the client during the out
message processing.</p>

<h2><a name="Sample503">Sample 503:</a></h2>
<pre>&lt;synapse xmlns="http://ws.apache.org/ns/synapse"&gt;

    &lt;!-- Introduction to the script mediator with Ruby scripts--&gt;

    &lt;definitions&gt;

        &lt;!-- define a static property for the JRuby source code file --&gt;
        &lt;set-property name="stockquoteScript" src="file:repository/conf/sample/resources/script/stockquoteTransform.rb"/&gt;

        &lt;!-- define a reuseable endpoint definition and use it within config --&gt;
        &lt;endpoint name="stockquote" address="http://localhost:9000/axis2/services/SimpleStockQuoteService"/&gt;

    &lt;/definitions&gt;

    &lt;rules&gt;
        &lt;in&gt;
            &lt;!-- transform the custom quote request into a standard quote request expected by the service --&gt;
            &lt;script key="stockquoteScript" function="transformRequest"/&gt;

            &lt;!-- send message to real endpoint referenced by name "stockquote" and stop --&gt;
            &lt;send&gt;
                &lt;endpoint ref="stockquote"/&gt;
            &lt;/send&gt;
        &lt;/in&gt;

        &lt;out&gt;
            &lt;!-- transform the standard response back into the custom format the client expects --&gt;
            &lt;script key="stockquoteScript" function="transformResponse"/&gt;

            &lt;!-- now send the custom response back to the client and stop --&gt;
            &lt;send/&gt;
        &lt;/out&gt;
    &lt;/rules&gt;

&lt;/synapse&gt; </pre>

<p><strong>Objective: Script mediators using Ruby</strong></p>

<p>This sample is similar to sample 500 but instead of using JavaScript the
script language is Ruby using the JRuby interpreter.</p>

<p>The Synapse config XML for this is <a
href="../repository/conf/sample/synapse_sample_503.xml"
type="text/txt">synapse_sample_503.xml</a> and the associated JavaScript
program is <a
href="../repository/conf/sample/resources/script/stockquoteTransform.rb"
type="text/txt">stockquoteTransform.rb</a>.</p>

<p><strong>Pre-Requisites:</strong></p>

<p>This sample uses Ruby so first setup support for this in Synapse as
described at <a href="#ScriptSetupRuby">Configuring JRuby</a>. </p>

<p>Start the Synapse configuration numbered 503: i.e. bin/synapse -sample
503<br>
Start the Axis2 server and deploy the SimpleStockQuoteService (Refer steps
above)</p>

<p>The Ruby script is in a separate file which the Synapse xml references by
using a static property named 'stockquoteScript'. The script has two
functions, 'transformRequest' and 'transformResponse', and the Synapse xml
script element uses the function attribute to specify which function to use
for the in and out rules.</p>

<p>Execute the custom quote client as 'ant customquote' and check analyze the
the Synapse debug log output as shown below</p>
<pre>DEBUG XSLTMediator - Transformation source :&lt;m0:CheckPriceRequest xmlns:m0=http://www.apache-synapse.org/test&gt;
&lt;m0:Code&gt;IBM&lt;/m0:Code&gt;&lt;/m0:CheckPriceRequest&gt;
DEBUG XSLTMediator - Transformation result :
&lt;m:getQuote xmlns:m=http://services.samples/xsd&gt;
&lt;m:request&gt;&lt;m:symbol&gt;IBM&lt;/m:symbol&gt;&lt;/m:request&gt;&lt;/m:getQuote&gt;</pre>

<p>The incoming message is now transformed into a standard stock quote
request as expected by the SimpleStockQuoteService deployed on the local
Axis2 instance by the Ruby mediator. The Ruby mediator uses REXML to perform
XML transformations. The response from the SimpleStockQuoteService is
converted into the custom format as expected by the client during the out
message processing.</p>
</body>
</html>
